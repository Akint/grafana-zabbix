define(["lodash","moment","app/plugins/sdk","angular","jquery","app/core/utils/datemath","app/core/config","app/core/table_model"],function(e,t,n,r,a,i,u,o){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=35)}([,function(t,n){t.exports=e},,function(e,n){e.exports=t},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.regexPattern=void 0,t.expandItemName=u,t.expandItems=function(e){return r.default.forEach(e,function(e){return e.item=e.name,e.name=u(e.item,e.key_),e}),e},t.containsMacro=function(e){return o.test(e)},t.replaceMacro=function(e,t){var n=e.name,a=n.match(o);return r.default.forEach(a,function(a){var i=r.default.filter(t,function(t){return!t.hostid||t.hostid===e.hostid}),u=r.default.find(i,{macro:a});if(u&&u.value){var o=u.value,s=new RegExp(function(e){return e=e.replace(/\$/,"\\$")}(a));n=n.replace(s,o)}}),n},t.splitTemplateQuery=function(e){var t=void 0;if(function(e){return/^\{.+\}$/.test(e)}(e)){var n=e.match(/\{[^\{\}]*\}|\{\/.*\/\}/g);t=r.default.map(n,function(e){return r.default.trim(e,"{}")})}else t=e.split(".");return t},t.isRegex=function(e){return s.test(e)},t.isTemplateVariable=function(e,t){if(/^\$\w+/.test(e)){var n=r.default.map(t,function(e){return"$"+e.name});return r.default.includes(n,e)}return!1},t.buildRegex=function(e){var t=e.match(s),n=t[1],r=""!==t[2]?t[2]:void 0;return new RegExp(n,r)},t.escapeRegex=function(e){return e.replace(/[\\^$*+?.()|[\]{}\/]/g,"\\$&")},t.parseInterval=function(e){var t=/(^[\d]+)(y|M|w|d|h|m|s)/g.exec(e);return a.default.duration(Number(t[1]),t[2]).valueOf()},t.parseTimeShiftInterval=function(e){var t=/^([\+\-]*)([\d]+)(y|M|w|d|h|m|s)/g.exec(e),n=0;n="+"===t[1]?0-a.default.duration(Number(t[2]),t[3]).valueOf():a.default.duration(Number(t[2]),t[3]).valueOf();return n},t.formatAcknowledges=function(e){if(e.length){var t="<br><br>Acknowledges:<br><table><tr><td><b>Time</b></td><td><b>User</b></td><td><b>Comments</b></td></tr>";return r.default.each(r.default.map(e,function(e){var t=a.default.unix(e.clock);return"<tr><td><i>"+t.format("DD MMM YYYY HH:mm:ss")+"</i></td><td>"+e.alias+" ("+e.name+" "+e.surname+")</td><td>"+e.message+"</td></tr>"}),function(e){t=t.concat(e)}),t=t.concat("</table>")}return""},t.convertToZabbixAPIUrl=function(e){return e.match(/.*api_jsonrpc.php$/)?e:e.replace(/(.*?)[\/]*$/,"$1")},t.callOnce=function(e,t){return function(){return t||(t=Promise.resolve(e.apply(this,arguments).then(function(e){return t=null,e}))),t}},t.sequence=function(e){return function(t){for(var n=0;n<e.length;n++)t=e[n].call(this,t);return t}},t.isValidVersion=function(e){return l.exec(e)},t.parseVersion=function(e){var t=l.exec(e);if(!t)return null;var n=Number(t[1]),r=Number(t[2]||0),a=Number(t[3]||0),i=t[4];return{major:n,minor:r,patch:a,meta:i}},t.compactQuery=function(e){return e.replace(/\s+/g," ").trim()};var r=i(n(1)),a=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}function u(e,t){for(var n=function(e){var t=[],n=!1,a=!1,i="";return r.default.forEach(e,function(e){'"'===e&&a?i+=e:'"'===e&&n?n=!1:'"'!==e||n?"["!==e||n?"]"!==e||n?","!==e||n||a?i+=e:(t.push(i),i=""):a=!1:a=!0:n=!0}),t.push(i),t}(t.substring(t.indexOf("[")+1,t.lastIndexOf("]"))),a=n.length;a>=1;a--)e=e.replace("$"+a,n[a-1]);return e}var o=/{\$[A-Z0-9_\.]+}/g;var s=t.regexPattern=/^\/(.*)\/([gmi]*)$/m;var l=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/;r.default.includes||(r.default.includes=r.default.contains)},,function(e,t){e.exports=n},,,,function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.DATAPOINT_VALUE=0,t.DATAPOINT_TS=1,t.MODE_METRICS=0,t.MODE_ITSERVICE=1,t.MODE_TEXT=2,t.MODE_ITEMID=3,t.MODE_TRIGGERS=4,t.SEV_NOT_CLASSIFIED=0,t.SEV_INFORMATION=1,t.SEV_WARNING=2,t.SEV_AVERAGE=3,t.SEV_HIGH=4,t.SEV_DISASTER=5,t.SHOW_ALL_TRIGGERS=[0,1],t.SHOW_ALL_EVENTS=[0,1],t.SHOW_OK_EVENTS=1,t.ZBX_ACK_ACTION_NONE=0,t.ZBX_ACK_ACTION_ACK=2,t.ZBX_ACK_ACTION_ADD_MESSAGE=4,t.TRIGGER_SEVERITY=[{val:0,text:"Not classified"},{val:1,text:"Information"},{val:2,text:"Warning"},{val:3,text:"Average"},{val:4,text:"High"},{val:5,text:"Disaster"}]},,,,,function(e,t){e.exports=i},function(e,t,n){"use strict";n.r(t),n.d(t,"isGrafana2target",function(){return i}),n.d(t,"migrateFrom2To3version",function(){return u}),n.d(t,"migrate",function(){return o}),n.d(t,"DS_CONFIG_SCHEMA",function(){return l}),n.d(t,"migrateDSConfig",function(){return c});var r=n(1),a=n.n(r);function i(e){return(!e.mode||0===e.mode||2===e.mode)&&!(!(e.hostFilter||e.itemFilter||e.downsampleFunction||e.host&&e.host.host)||void 0!==e.item.filter||void 0!==e.host.filter)}function u(e){return e.group.filter="*"===e.group.name?"/.*/":e.group.name,e.host.filter="*"===e.host.name?s(e.hostFilter):e.host.name,e.application.filter="*"===e.application.name?"":e.application.name,e.item.filter="All"===e.item.name?s(e.itemFilter):e.item.name,e}function o(e){return e.resultFormat=e.resultFormat||"time_series",i(e=function(e){e.group&&Array.isArray(e.group)&&(e.group={filter:""});return e}(e))?u(e):e}function s(e){return e?"/"+e+"/":"/.*/"}var l=2;function c(e){if(e||(e={}),!function(e){if(e.dbConnection&&!a.a.isEmpty(e.dbConnection))return!0;if(e.schema&&e.schema!==l)return!0;return!1}(e))return e;var t=e.schema||1;if(e.schema=l,t<2){var n=e.dbConnection||{};e.dbConnectionEnable=n.enable||!1,e.dbConnectionDatasourceId=n.datasourceId||null,delete e.dbConnection}return e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();t.createFuncInstance=function(e,t){if(a.default.isString(e)){if(!o[e])throw{message:"Method not found "+name};e=o[e]}return new c(e,t)},t.getFuncDef=function(e){return o[e]},t.getCategories=function(){return s};var a=u(n(1)),i=u(n(11));function u(e){return e&&e.__esModule?e:{default:e}}var o=[],s={Transform:[],Aggregate:[],Filter:[],Trends:[],Time:[],Alias:[],Special:[]};function l(e){e.params=e.params||[],e.defaultParams=e.defaultParams||[],e.category&&s[e.category].push(e),o[e.name]=e,o[e.shortName||e.name]=e}l({name:"groupBy",category:"Transform",params:[{name:"interval",type:"string"},{name:"function",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:["1m","avg"]}),l({name:"scale",category:"Transform",params:[{name:"factor",type:"float",options:[100,.01,10,-1]}],defaultParams:[100]}),l({name:"offset",category:"Transform",params:[{name:"delta",type:"float",options:[-100,100]}],defaultParams:[100]}),l({name:"delta",category:"Transform",params:[],defaultParams:[]}),l({name:"rate",category:"Transform",params:[],defaultParams:[]}),l({name:"movingAverage",category:"Transform",params:[{name:"factor",type:"int",options:[6,10,60,100,600]}],defaultParams:[10]}),l({name:"exponentialMovingAverage",category:"Transform",params:[{name:"smoothing",type:"float",options:[6,10,60,100,600]}],defaultParams:[.2]}),l({name:"removeAboveValue",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),l({name:"removeBelowValue",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),l({name:"transformNull",category:"Transform",params:[{name:"number",type:"float"}],defaultParams:[0]}),l({name:"sumSeries",category:"Aggregate",params:[],defaultParams:[]}),l({name:"median",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"average",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"percentil",category:"Aggregate",params:[{name:"interval",type:"string"},{name:"percent",type:"float",options:[25,50,75,90,95,99,99.9]}],defaultParams:["1m",95]}),l({name:"min",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"max",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"sum",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"count",category:"Aggregate",params:[{name:"interval",type:"string"}],defaultParams:["1m"]}),l({name:"aggregateBy",category:"Aggregate",params:[{name:"interval",type:"string"},{name:"function",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:["1m","avg"]}),l({name:"top",category:"Filter",params:[{name:"number",type:"int"},{name:"value",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:[5,"avg"]}),l({name:"bottom",category:"Filter",params:[{name:"number",type:"int"},{name:"value",type:"string",options:["avg","min","max","sum","count","median"]}],defaultParams:[5,"avg"]}),l({name:"sortSeries",category:"Filter",params:[{name:"direction",type:"string",options:["asc","desc"]}],defaultParams:["asc"]}),l({name:"trendValue",category:"Trends",params:[{name:"type",type:"string",options:["avg","min","max","sum","count"]}],defaultParams:["avg"]}),l({name:"timeShift",category:"Time",params:[{name:"interval",type:"string",options:["24h","7d","1M","+24h","-24h"]}],defaultParams:["24h"]}),l({name:"setAlias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:[]}),l({name:"setAliasByRegex",category:"Alias",params:[{name:"aliasByRegex",type:"string"}],defaultParams:[]}),l({name:"replaceAlias",category:"Alias",params:[{name:"regexp",type:"string"},{name:"newAlias",type:"string"}],defaultParams:["/(.*)/","$1"]}),l({name:"consolidateBy",category:"Special",params:[{name:"type",type:"string",options:["avg","min","max","sum","count"]}],defaultParams:["avg"]}),a.default.each(s,function(e,t){s[t]=a.default.sortBy(e,"name")});var c=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.def=t,n?this.params=n:(this.params=[],this.params=t.defaultParams.slice(0)),this.updateText()}return r(e,[{key:"bindFunction",value:function(e){var t=e[this.def.name];if(t){for(var n,r=t,i=0;i<this.params.length;i++)n=this.params[i],"int"!==this.def.params[i].type&&"float"!==this.def.params[i].type||(n=Number(n)),r=a.default.partial(r,n);return r}throw{message:"Method not found "+this.def.name}}},{key:"render",value:function(e){var t=this.def.name+"(",n=a.default.map(this.params,function(e,t){var n=this.def.params[t].type;return"int"===n||"float"===n||"value_or_series"===n||"boolean"===n?e:"int_or_interval"===n&&i.default.isNumeric(e)?e:"'"+e+"'"},this);return e&&n.unshift(e),t+n.join(", ")+")"}},{key:"_hasMultipleParamsInString",value:function(e,t){return-1!==e.indexOf(",")&&(this.def.params[t+1]&&this.def.params[t+1].optional)}},{key:"updateParam",value:function(e,t){this._hasMultipleParamsInString(e,t)?a.default.each(e.split(","),function(e,t){this.updateParam(e.trim(),t)},this):(""===e&&this.def.params[t].optional?this.params.splice(t,1):this.params[t]=e,this.updateText())}},{key:"updateText",value:function(){if(0!==this.params.length){var e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}else this.text=this.def.name+"()"}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZabbixNotImplemented=t.DBConnector=t.consolidateByTrendColumns=t.consolidateByFunc=t.TREND_TO_TABLE_MAP=t.HISTORY_TO_TABLE_MAP=t.DEFAULT_QUERY_LIMIT=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(n(1));function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var u=t.DEFAULT_QUERY_LIMIT=1e4,o=t.HISTORY_TO_TABLE_MAP={0:"history",1:"history_str",2:"history_log",3:"history_uint",4:"history_text"},s=t.TREND_TO_TABLE_MAP={0:"trends",3:"trends_uint"},l=t.consolidateByFunc={avg:"AVG",min:"MIN",max:"MAX",sum:"SUM",count:"COUNT"},c=t.consolidateByTrendColumns={avg:"value_avg",min:"value_min",max:"value_max",sum:"num*value_avg"},f=t.DBConnector=function(){function e(t,n){i(this,e),this.datasourceSrv=n,this.datasourceId=t.datasourceId,this.datasourceName=t.datasourceName,this.datasourceTypeId=null,this.datasourceTypeName=null}return r(e,[{key:"loadDBDataSource",value:function(){var t=this;return e.loadDatasource(this.datasourceId,this.datasourceName,this.datasourceSrv).then(function(e){return t.datasourceTypeId=e.meta.id,t.datasourceTypeName=e.meta.name,t.datasourceName||(t.datasourceName=e.name),e})}},{key:"testDataSource",value:function(){throw new d("testDataSource()")}},{key:"getHistory",value:function(){throw new d("getHistory()")}},{key:"getTrends",value:function(){throw new d("getTrends()")}},{key:"handleGrafanaTSResponse",value:function(e,t){return function(e,t,n){var r=a.default.uniqBy(a.default.flatten(a.default.map(t,"hosts")),"hostid"),i=a.default.map(a.default.compact(e),function(e){var i=e.name,u=a.default.find(t,{itemid:i}),o=u.name;if(a.default.keys(r).length>1&&n){var s=a.default.find(r,{hostid:u.hostid});o=s.name+": "+o}var l=a.default.cloneDeep(e.points);return{target:o,datapoints:l}});return a.default.sortBy(i,"target")}(e,t,!(arguments.length>2&&void 0!==arguments[2])||arguments[2])}}],[{key:"loadDatasource",value:function(e,t,n){if(!t&&void 0!==e){var r=a.default.find(n.getAll(),{id:e});if(!r)return Promise.reject("Data Source with ID "+e+" not found");t=r.name}return t?n.loadDatasource(t):Promise.reject("Data Source name should be specified")}}]),e}(),d=t.ZabbixNotImplemented=function(){function e(t){i(this,e),this.code=null,this.name="ZabbixNotImplemented",this.message="Zabbix DB Connector Error: method "+(t||"")+" should be implemented in subclass of DBConnector"}return r(e,[{key:"toString",value:function(){return this.message}}]),e}();var p={DBConnector:f,DEFAULT_QUERY_LIMIT:u,HISTORY_TO_TABLE_MAP:o,TREND_TO_TABLE_MAP:s,consolidateByFunc:l,consolidateByTrendColumns:c};t.default=p},,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=u(n(1)),a=u(n(40)),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(12));function u(e){return e&&e.__esModule?e:{default:e}}function o(e,t,n,a){var i=r.default.groupBy(e,"itemid"),u=r.default.uniqBy(r.default.flatten(r.default.map(t,"hosts")),"hostid");return r.default.map(i,function(e,i){var o=r.default.find(t,{itemid:i}),s=o.name;r.default.keys(u).length>1&&n&&(s=r.default.find(u,{hostid:o.hostid}).name+": "+s);return{target:s,datapoints:r.default.map(e,a)}})}function s(e,t){var n=t.value;return e.textFilter&&(n=l(t.value,e.textFilter,e.useCaptureGroups)),[n,1e3*t.clock+Math.round(t.ns/1e6)]}function l(e,t,n){var r=new RegExp(t).exec(e);return r&&(r=n?r[1]:r[0]),r}function c(e){return[Number(e.value),1e3*e.clock+Math.round(e.ns/1e6)]}function f(e,t){var n;switch(e){case"min":n=t.value_min;break;case"max":n=t.value_max;break;case"avg":n=t.value_avg;break;case"sum":n=t.value_sum;break;case"count":n=t.value_count;break;default:n=t.value_avg}return[Number(n),1e3*t.clock]}t.default={handleHistory:function(e,t){return o(e,t,!(arguments.length>2&&void 0!==arguments[2])||arguments[2],c)},convertHistory:o,handleTrends:function(e,t,n){return o(e,t,!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r.default.partial(f,n))},handleText:function(e,t,n){return o(e,t,!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r.default.partial(s,n))},handleHistoryAsTable:function(e,t,n){var i=new a.default;i.addColumn({text:"Host"}),i.addColumn({text:"Item"}),i.addColumn({text:"Key"}),i.addColumn({text:"Last value"});var u=r.default.groupBy(e,"itemid");return r.default.each(t,function(e){var t=u[e.itemid]||[],a=r.default.last(t),o=a?a.value:null;if(!n.options.skipEmptyValues||o&&""!==o){n.textFilter&&(o=l(o,n.textFilter,n.useCaptureGroups));var s=r.default.first(e.hosts);s=s?s.name:"",i.rows.push([s,e.name,e.key_,o])}}),i},handleSLAResponse:function(e,t,n){var r=n[e.serviceid].sla[0];if("status"===t.property){var a=parseInt(n[e.serviceid].status);return{target:e.name+" "+t.name,datapoints:[[a,1e3*r.to]]}}return{target:e.name+" "+t.name,datapoints:[[r[t.property],1e3*r.from],[r[t.property],1e3*r.to]]}},handleTriggersResponse:function(e,t){if(r.default.isNumber(e))return{target:"triggers count",datapoints:[[e,1e3*t[1]]]};var n=function(e){var t=r.default.uniq(r.default.flattenDeep(r.default.map(e,function(e){return r.default.map(e.groups,"name")}))),n={};return r.default.each(t,function(e){n[e]={0:0,1:0,2:0,3:0,4:0,5:0}}),r.default.each(e,function(e){r.default.each(e.groups,function(t){n[t.name][e.priority]++})}),n}(e),u=new a.default;return u.addColumn({text:"Host group"}),r.default.each(r.default.orderBy(i.TRIGGER_SEVERITY,["val"],["desc"]),function(e){u.addColumn({text:e.text})}),r.default.each(n,function(e,t){var n=r.default.map(r.default.orderBy(r.default.toPairs(e),function(e){return e[0]},["desc"]),function(e){return e[1]});n=r.default.concat.apply(r.default,[[t]].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(n))),u.rows.push(n)}),u},sortTimeseries:function(e){return r.default.forEach(e,function(e){e.datapoints=r.default.sortBy(e.datapoints,function(e){return e[i.DATAPOINT_TS]})}),e}},r.default.uniqBy||(r.default.uniqBy=r.default.uniq)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.ZabbixAPICore=function(){function e(t){a(this,e),this.backendSrv=t}return e.$inject=["backendSrv"],r(e,[{key:"request",value:function(e,t,n,r,a){var u={jsonrpc:"2.0",method:t,params:n,id:1};if(""===a)return Promise.reject(new i({data:"Not authorised."}));a&&(u.auth=a);var o={method:"POST",url:e,data:u,headers:{"Content-Type":"application/json"}};return(r.basicAuth||r.withCredentials)&&(o.withCredentials=!0),r.basicAuth&&(o.headers.Authorization=r.basicAuth),this.datasourceRequest(o)}},{key:"datasourceRequest",value:function(e){return this.backendSrv.datasourceRequest(e).then(function(e){return e.data?e.data.error?Promise.reject(new i(e.data.error)):e.data.result:Promise.reject(new i({data:"General Error, no data"}))})}},{key:"login",value:function(e,t,n,r){var a={user:t,password:n};return this.request(e,"user.login",a,r,null)}},{key:"getVersion",value:function(e,t){return this.request(e,"apiinfo.version",[],t)}}]),e}();var i=t.ZabbixAPIError=function(){function e(t){a(this,e),this.code=t.code||null,this.name=t.message||"",this.data=t.data||"",this.message="Zabbix API Error: "+this.name+" "+this.data}return r(e,[{key:"toString",value:function(){return this.name+" "+this.data}}]),e}()},,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnnotationsQueryCtrl=t.QueryOptionsCtrl=t.QueryCtrl=t.ConfigCtrl=t.Datasource=void 0;var r=n(6),a=n(36),i=n(48),u=n(49);function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n(50),n(51),n(52);var s=function e(){o(this,e)};s.templateUrl="datasource-zabbix/partials/query.options.html";var l=function e(){o(this,e)};l.templateUrl="datasource-zabbix/partials/annotations.editor.html",i.ZabbixQueryController.templateUrl="datasource-zabbix/partials/query.editor.html",u.ZabbixDSConfigController.templateUrl="datasource-zabbix/partials/config.html",(0,r.loadPluginCss)({dark:"plugins/alexanderzobnin-zabbix-app/css/grafana-zabbix.dark.css",light:"plugins/alexanderzobnin-zabbix-app/css/grafana-zabbix.light.css"}),t.Datasource=a.ZabbixDatasource,t.ConfigCtrl=u.ZabbixDSConfigController,t.QueryCtrl=i.ZabbixQueryController,t.QueryOptionsCtrl=s,t.AnnotationsQueryCtrl=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZabbixDatasource=void 0;var r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(r=(u=o.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();t.zabbixTemplateFormat=x;var i=g(n(1)),u=g(n(37)),o=v(n(17)),s=v(n(4)),l=v(n(18)),c=v(n(19)),f=v(n(12)),d=g(n(38)),p=g(n(28)),m=n(41),h=n(29);function v(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function g(e){return e&&e.__esModule?e:{default:e}}var y=3;t.ZabbixDatasource=function(){function e(t,n,r,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.templateSrv=n,this.zabbixAlertingSrv=o,this.enableDebugLog="development"===u.default.buildInfo.env,this.replaceTemplateVars=i.default.partial(A,this.templateSrv),this.name=t.name,this.url=t.url,this.basicAuth=t.basicAuth,this.withCredentials=t.withCredentials;var c=l.migrateDSConfig(t.jsonData);this.username=c.username,this.password=c.password,this.trends=c.trends,this.trendsFrom=c.trendsFrom||"7d",this.trendsRange=c.trendsRange||"4d";var d=c.cacheTTL||"1h";this.cacheTTL=s.parseInterval(d),this.alertingEnabled=c.alerting,this.addThresholds=c.addThresholds,this.alertingMinSeverity=c.alertingMinSeverity||f.SEV_WARNING,this.disableReadOnlyUsersAck=c.disableReadOnlyUsersAck,this.zabbixVersion=c.zabbixVersion||y,this.enableDirectDBConnection=c.dbConnectionEnable||!1,this.dbConnectionDatasourceId=c.dbConnectionDatasourceId,this.dbConnectionDatasourceName=c.dbConnectionDatasourceName,this.dbConnectionRetentionPolicy=c.dbConnectionRetentionPolicy;var p={url:this.url,username:this.username,password:this.password,basicAuth:this.basicAuth,withCredentials:this.withCredentials,zabbixVersion:this.zabbixVersion,cacheTTL:this.cacheTTL,enableDirectDBConnection:this.enableDirectDBConnection,dbConnectionDatasourceId:this.dbConnectionDatasourceId,dbConnectionDatasourceName:this.dbConnectionDatasourceName,dbConnectionRetentionPolicy:this.dbConnectionRetentionPolicy};this.zabbix=new m.Zabbix(p,a,r)}return e.$inject=["instanceSettings","templateSrv","backendSrv","datasourceSrv","zabbixAlertingSrv"],a(e,[{key:"query",value:function(e){var t=this;this.alertingEnabled&&this.alertQuery(e).then(function(n){t.zabbixAlertingSrv.setPanelAlertState(e.panelId,n.state),t.zabbixAlertingSrv.removeZabbixThreshold(e.panelId),t.addThresholds&&i.default.forEach(n.thresholds,function(n){t.zabbixAlertingSrv.setPanelThreshold(e.panelId,n)})});var n=i.default.map(e.targets,function(n){if(n.hide)return[];var a=Math.ceil(o.parse(e.range.from)/1e3),u=Math.ceil(o.parse(e.range.to)/1e3),c=i.default.cloneDeep(n);c=l.migrate(c),t.replaceTargetVariables(c,e);var d=b(c.functions,"Time");if(d.length){var p=s.sequence(d)([a,u]),m=r(p,2);a=m[0],u=m[1]}var h=[a,u],v=t.isUseTrends(h);return c.mode&&c.mode!==f.MODE_METRICS&&c.mode!==f.MODE_TEXT?c.mode===f.MODE_ITEMID?c.itemids?t.queryItemIdData(c,h,v,e):[]:c.mode===f.MODE_ITSERVICE?t.queryITServiceData(c,h,e):c.mode===f.MODE_TRIGGERS?t.queryTriggersData(c,h):[]:c.group&&c.host&&c.item?c.mode&&c.mode!==f.MODE_METRICS?c.mode===f.MODE_TEXT?t.queryTextData(c,h):void 0:t.queryNumericData(c,h,v,e):[]});return Promise.all(i.default.flatten(n)).then(i.default.flatten).then(function(e){return{data:e}})}},{key:"queryNumericData",value:function(e,t,n,r){var a=this,i=void 0,u=void 0;return this.zabbix.getItemsFromTarget(e,{itemtype:"num"}).then(function(u){return i=(new Date).getTime(),a.queryNumericDataForItems(u,e,t,n,r)}).then(function(e){return u=(new Date).getTime(),a.enableDebugLog&&console.debug("Datasource::Performance Query Time ("+a.name+"): "+(u-i)),e})}},{key:"queryNumericDataForItems",value:function(e,t,n,r,a){var u=this;return a.valueType=this.getTrendValueType(t),a.consolidateBy=function(e){var t=void 0,n=i.default.find(e.functions,function(e){return"consolidateBy"===e.def.name});n&&n.params&&n.params.length&&(t=n.params[0]);return t}(t)||a.valueType,(r?this.zabbix.getTrends(e,n,a):this.zabbix.getHistoryTS(e,n,a)).then(function(e){return u.applyDataProcessingFunctions(e,t)}).then(function(e){return function(e,t){var n=d.default.aggregationFunctions.avg,r=d.default.aggregationFunctions[t.consolidateBy]||n;return i.default.map(e,function(e){return e.datapoints.length>t.maxDataPoints&&(e.datapoints=d.default.groupBy(t.interval,r,e.datapoints)),e})}(e,a)})}},{key:"getTrendValueType",value:function(e){var t=i.default.map(c.getCategories().Trends,"name"),n=i.default.find(e.functions,function(e){return i.default.includes(t,e.def.name)});return n?n.params[0]:"avg"}},{key:"applyDataProcessingFunctions",value:function(e,t){var n=b(t.functions,"Transform"),r=b(t.functions,"Aggregate"),a=b(t.functions,"Filter"),u=b(t.functions,"Alias");if(e=i.default.cloneDeep(i.default.map(e,function(e){return e.datapoints=s.sequence(n)(e.datapoints),e})),a.length&&(e=s.sequence(a)(e)),r.length){var o=i.default.map(e,"datapoints");o=s.sequence(r)(o);var l=i.default.map(c.getCategories().Aggregate,"name");e=[{target:i.default.findLast(t.functions,function(e){return i.default.includes(l,e.def.name)}).text,datapoints:o}]}return i.default.forEach(e,s.sequence(u)),this.applyTimeShiftFunction(e,t),e}},{key:"applyTimeShiftFunction",value:function(e,t){var n=i.default.find(t.functions,function(e){return"timeShift"===e.def.name});if(n){var r=n.params[0];i.default.forEach(e,function(e){e.datapoints=d.default.unShiftTimeSeries(r,e.datapoints)})}}},{key:"queryTextData",value:function(e,t){var n=this;return this.zabbix.getItemsFromTarget(e,{itemtype:"text"}).then(function(r){return n.zabbix.getHistoryText(r,t,e)})}},{key:"queryItemIdData",value:function(e,t,n,r){var a=this,u=e.itemids;return u=this.templateSrv.replace(u,r.scopedVars,_),(u=i.default.map(u.split(","),function(e){return e.trim()}))?this.zabbix.getItemsByIDs(u).then(function(i){return a.queryNumericDataForItems(i,e,t,n,r)}):[]}},{key:"queryITServiceData",value:function(e,t,n){var r=this;if(e.hide||!e.itservice&&!e.itServiceFilter||!e.slaProperty)return[];var a=void 0;return n.isOldVersion=e.itservice&&!e.itServiceFilter,a=n.isOldVersion?"/.*/":this.replaceTemplateVars(e.itServiceFilter,n.scopedVars),this.zabbix.getITServices(a).then(function(a){return r.zabbix.getSLA(a,t,e,n)})}},{key:"queryTriggersData",value:function(e,t){var n=this,a=r(t,2),u=a[0],o=a[1];return this.zabbix.getHostsFromTarget(e).then(function(a){var s=r(a,2),l=s[0],c=s[1];if(l.length){var f=i.default.map(l,"hostid"),d=i.default.map(c,"applicationid"),m={minSeverity:e.triggers.minSeverity,acknowledged:e.triggers.acknowledged,count:e.triggers.count,timeFrom:u,timeTo:o};return n.zabbix.getHostAlerts(f,d,m).then(function(e){return p.default.handleTriggersResponse(e,t)})}return Promise.resolve([])})}},{key:"testDatasource",value:function(){return this.zabbix.testDataSource().then(function(e){var t=e.zabbixVersion,n=e.dbConnectorStatus,r="Zabbix API version: "+t;return n&&(r+=", DB connector type: "+n.dsType),{status:"success",title:"Success",message:r}}).catch(function(e){return e instanceof h.ZabbixAPIError?{status:"error",title:e.message,message:e.message}:e.data&&e.data.message?{status:"error",title:"Connection failed",message:"Connection failed: "+e.data.message}:"string"==typeof e?{status:"error",title:"Connection failed",message:"Connection failed: "+e}:(console.log(e),{status:"error",title:"Connection failed",message:"Could not connect to given url"})})}},{key:"getVersion",value:function(){return this.zabbix.getVersion().then(function(e){var t=s.parseVersion(e);return t?t.major:null})}},{key:"metricFindQuery",value:function(e){var t=this,n=void 0,r=[];i.default.each(s.splitTemplateQuery(e),function(e){"*"===(e=t.replaceTemplateVars(e,{}))&&(e="/.*/"),r.push(e)});var a=i.default.zipObject(["group","host","app","item"],r);return 4===r.length?("/.*/"===a.app&&(a.app=""),n=this.zabbix.getItems(a.group,a.host,a.app,a.item)):n=3===r.length?this.zabbix.getApps(a.group,a.host,a.app):2===r.length?this.zabbix.getHosts(a.group,a.host):1===r.length?this.zabbix.getGroups(a.group):Promise.resolve([]),n.then(function(e){return i.default.map(e,T)})}},{key:"annotationQuery",value:function(e){var t=this,n=e.range||e.rangeRaw,r=Math.ceil(o.parse(n.from)/1e3),a=Math.ceil(o.parse(n.to)/1e3),u=e.annotation,l=u.showOkEvents?f.SHOW_ALL_EVENTS:f.SHOW_OK_EVENTS,c={showTriggers:f.SHOW_ALL_TRIGGERS,hideHostsInMaintenance:!1};return this.zabbix.getTriggers(this.replaceTemplateVars(u.group,{}),this.replaceTemplateVars(u.host,{}),this.replaceTemplateVars(u.application,{}),c).then(function(e){var n=t.replaceTemplateVars(u.trigger,{});s.isRegex(n)?e=i.default.filter(e,function(e){return s.buildRegex(n).test(e.description)}):n&&(e=i.default.filter(e,function(e){return e.description===n})),e=i.default.filter(e,function(e){return Number(e.priority)>=Number(u.minseverity)});var o=i.default.map(e,"triggerid");return t.zabbix.getEvents(o,r,a,l).then(function(t){var n=i.default.keyBy(e,"triggerid");return u.hideAcknowledged&&(t=i.default.filter(t,function(e){return!e.acknowledges.length})),i.default.map(t,function(e){var t=void 0;u.showHostname&&(t=i.default.map(e.hosts,"name"));var r=Number(e.value)?"Problem":"OK",a=s.formatAcknowledges(e.acknowledges);return{annotation:u,time:1e3*e.clock,title:r,tags:t,text:n[e.objectid].description+a}})})})}},{key:"alertQuery",value:function(e){var t=this,n=function(e){return i.default.filter(e,function(e){return!(e.hide||!e.group||!e.host||!e.item)})}(e.targets),r=i.default.map(n,function(n){var r=i.default.cloneDeep(n);return r=l.migrate(r),t.replaceTargetVariables(r,e),t.zabbix.getItemsFromTarget(r,{itemtype:"num"})});return Promise.all(r).then(function(e){var n=i.default.flatten(e),r=i.default.map(n,"itemid");return 0===r.length?[]:t.zabbix.getAlerts(r)}).then(function(n){if(!(n=i.default.filter(n,function(e){return e.priority>=t.alertingMinSeverity}))||0===n.length)return{};var r="ok";i.default.filter(n,{value:"1"}).length&&(r="alerting");var a=i.default.map(n,function(e){return function(e){var t=e.match(/.*[<>=]{1,2}([\d\.]+)/);if(t&&t.length>=2){var n=t[1];return n=Number(n)}return null}(e.expression)});return{panelId:e.panelId,state:r,thresholds:a}})}},{key:"replaceTargetVariables",value:function(e,t){var n=this;i.default.forEach(["group","host","application","item"],function(r){e[r]&&e[r].filter&&(e[r].filter=n.replaceTemplateVars(e[r].filter,t.scopedVars))}),e.textFilter=this.replaceTemplateVars(e.textFilter,t.scopedVars),i.default.forEach(e.functions,function(e){e.params=i.default.map(e.params,function(e){return"number"==typeof e?+n.templateSrv.replace(e.toString(),t.scopedVars):n.templateSrv.replace(e,t.scopedVars)})})}},{key:"isUseTrends",value:function(e){var t=r(e,2),n=t[0],a=t[1],i=Math.ceil(o.parse("now-"+this.trendsFrom)/1e3),u=Math.ceil(s.parseInterval(this.trendsRange)/1e3);return this.trends&&(n<i||a-n>u)}}]),e}();function b(e,t){var n=i.default.map(c.getCategories()[t],"name"),r=i.default.filter(e,function(e){return i.default.includes(n,e.def.name)});return i.default.map(r,function(e){return c.createFuncInstance(e.def,e.params).bindFunction(d.default.metricFunctions)})}function T(e){return{text:e.name,expandable:!1}}function x(e){return"string"==typeof e?s.escapeRegex(e):"("+i.default.map(e,s.escapeRegex).join("|")+")"}function _(e){return"string"==typeof e?e:e.join(",")}function A(e,t,n){var r=e.replace(t,n,x);return t===r||s.isRegex(r)||(r="/^"+r+"$/"),r}i.default.includes||(i.default.includes=i.default.contains),i.default.keyBy||(i.default.keyBy=i.default.indexBy)},function(e,t){e.exports=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=u(n(1)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4)),i=u(n(39));function u(e){return e&&e.__esModule?e:{default:e}}var o=i.default.downsample,s=i.default.groupBy_perf,l=i.default.sumSeries,c=i.default.delta,f=i.default.rate,d=i.default.SUM,p=i.default.COUNT,m=i.default.AVERAGE,h=i.default.MIN,v=i.default.MAX,g=i.default.MEDIAN,y=i.default.PERCENTIL;function b(e,t,n,a){var i=_[n],u=r.default.sortBy(a,function(e){var t=r.default.map(e.datapoints,function(e){return e[0]});return i(t)});return"bottom"===e?u.slice(0,t):u.slice(-t)}function T(e,t,n){var a=r.default.flatten(n,!0),u=i.default.sortByTime(a);return s(u,t,e)}var x={groupBy:function(e,t,n){var r=_[t];return s(n,e,r)},scale:function(e,t){return i.default.scale_perf(t,e)},offset:function(e,t){return i.default.offset(t,e)},delta:c,rate:f,movingAverage:function(e,t){return i.default.simpleMovingAverage(t,e)},exponentialMovingAverage:function(e,t){return i.default.expMovingAverage(t,e)},transformNull:function(e,t){return r.default.map(t,function(t){return[null!==t[0]?t[0]:e,t[1]]})},aggregateBy:function(e,t,n){var a=r.default.flatten(n,!0),u=i.default.sortByTime(a),o=_[t];return s(u,e,o)},percentil:function(e,t,n){var a=r.default.flatten(n,!0),i=r.default.partial(y,t);return s(a,e,i)},average:r.default.partial(T,m),min:r.default.partial(T,h),max:r.default.partial(T,v),median:r.default.partial(T,g),sum:r.default.partial(T,d),count:r.default.partial(T,p),sumSeries:l,removeAboveValue:function(e,t){return r.default.map(t,function(t){return[t[0]>e?null:t[0],t[1]]})},removeBelowValue:function(e,t){return r.default.map(t,function(t){return[t[0]<e?null:t[0],t[1]]})},top:r.default.partial(b,"top"),bottom:r.default.partial(b,"bottom"),sortSeries:function(e,t){return r.default.orderBy(t,[function(e){return e.target.toLowerCase()}],e)},timeShift:function(e,t){var n=a.parseTimeShiftInterval(e)/1e3;return r.default.map(t,function(e){return e-n})},setAlias:function(e,t){return t.target=e,t},setAliasByRegex:function(e,t){return t.target=function(e,t){var n=new RegExp(t).exec(e);return n=n[0]}(t.target,e),t},replaceAlias:function(e,t,n){var r=void 0;r=a.isRegex(e)?a.buildRegex(e):e;var i=n.target.replace(r,t);return n.target=i,n}},_={avg:m,min:h,max:v,median:g,sum:d,count:p};t.default={downsampleSeries:o,groupBy:function(e,t,n){return s(n,e,t)},AVERAGE:m,MIN:h,MAX:v,MEDIAN:g,SUM:d,COUNT:p,unShiftTimeSeries:function(e,t){var n=a.parseTimeShiftInterval(e);return r.default.map(t,function(e){return[e[0],e[1]+n]})},get aggregationFunctions(){return _},get metricFunctions(){return x}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){return e&&e.__esModule?e:{default:e}}(n(1)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4));var i=0,u=1;function o(e){for(var t=null,n=0;n<e.length;n++)null!==e[n]&&(t+=e[n]);return t}function s(e,t){return Math.floor(e/t)*t}function l(e){return r.default.sortBy(e,function(e){return e[1]})}function c(e){for(var t,n,r=e.length-1;r>=0;r--)e[r][0]||(t=p(e,r),n=d(e,r),t||(t=n),n||(n=t),e[r][0]=f(e[r][1],t,n));return e}function f(e,t,n){return t[1]===n[1]?(t[0]+n[0])/2:t[0]+(n[0]-t[0])/(n[1]-t[1])*(e-t[1])}function d(e,t){for(var n=t;n<e.length;n++)if(null!==e[n][0])return e[n];return null}function p(e,t){for(var n=t;n>0;n--)if(null!==e[n][0])return e[n];return null}var m={downsample:function(e,t,n,a){for(var i=[],u={from:1e3*t-n,to:1e3*t},o=0,s=0,l=0,c=[],f=e.length-1;f>=0;f-=1)u.from<e[f][1]&&e[f][1]<=u.to?(o+=e[f][0],s++,c.push(e[f][0])):(l=s?o/s:0,"max"===a?i.push([r.default.max(c),u.to]):"min"===a?i.push([r.default.min(c),u.to]):i.push([l,u.to]),u.to=u.from,u.from-=n,o=0,s=0,c=[],f++);return i.reverse()},groupBy:function(e,t,n){var i=a.parseInterval(t),u=r.default.groupBy(e,function(e){return Math.floor(e[1]/i)*i}),o=r.default.mapValues(u,function(e){var t=r.default.map(e,function(e){return e[0]});return n(t)});return l(r.default.map(o,function(e,t){return[Number(e),Number(t)]}))},groupBy_perf:function(e,t,n){if(0===e.length)return[];for(var r=a.parseInterval(t),o=[],l=[],c=void 0,f=e.length?s(e[0][u],r):0,d=f,p=void 0,m=0;m<e.length;m++)if((d=s((p=e[m])[u],r))===f)l.push(p[i]);else if(d>f){for(c=n(l),o.push([c,f]),f+=r;f<d;)o.push([null,f]),f+=r;l=[p[i]]}return c=n(l),o.push([c,f]),o},sumSeries:function(e){var t=r.default.uniq(r.default.map(r.default.flatten(e,!0),function(e){return e[1]}));t=r.default.sortBy(t);var n=r.default.map(e,function(e){e=function(e,t){for(var n=[],a=[],i=void 0,o=0;o<t.length;o++)t[o]<e[0][u]?(i=[0,t[o]],n.push(i)):t[o]>e[e.length-1][u]&&(i=[0,t[o]],a.push(i));return r.default.concat(r.default.concat(n,e),a)}(e,t);var n=r.default.map(e,function(e){return e[1]}),a=r.default.map(r.default.difference(t,n),function(e){return[null,e]});return l(e.concat(a))});r.default.each(n,c);for(var a,i=[],o=t.length-1;o>=0;o--){a=0;for(var s=n.length-1;s>=0;s--)a+=n[s][o][0];i.push([a,t[o]])}return l(i)},scale:function(e,t){return r.default.map(e,function(e){return[e[0]*t,e[1]]})},offset:function(e,t){for(var n=0;n<e.length;n++)e[n]=[e[n][i]+t,e[n][u]];return e},scale_perf:function(e,t){for(var n=0;n<e.length;n++)e[n]=[e[n][i]*t,e[n][u]];return e},delta:function(e){for(var t=[],n=void 0,r=1;r<e.length;r++)n=e[r][0]-e[r-1][0],t.push([n,e[r][1]]);return t},rate:function(e){for(var t=[],n=void 0,r=void 0,a=0,o=0,s=1;s<e.length;s++)n=e[s],r=e[s-1],o=(n[u]-r[u])/1e3,n[i]>=r[i]&&(a=(n[i]-r[i])/o),t.push([a,n[u]]);return t},simpleMovingAverage:function(e,t){for(var n=[],r=void 0,a=null,o=0,s=t;s>0;s--)null!==e[t-s][i]&&(a+=e[t-s][i],o++);o>0?a/=o:a=null,n.push([a,e[t-1][u]]);for(var l=t;l<e.length;l++)null!==e[l][i]&&(a=((r=a*o)+e[l][i])/(o+1),o++),null!==e[l-t][i]&&(r=a*o,o>1?(a=(r-e[l-t][i])/(o-1),o--):(a=null,o=0)),n.push([a,e[l][u]]);return n},expMovingAverage:function(e,t){var n=[e[0]],r=e[0][i],a=void 0,o=void 0;if(t>1){o=2/(t+1);for(var s=null,l=0,c=t;c>0;c--)null!==e[t-c][i]&&(s+=e[t-c][i],l++);l>0&&(n=[[s/=l,e[0][u]]],r=s,t=1)}else o=t,t=1;for(var f=t;f<e.length;f++)null!==e[f][i]?(r=a=o*e[f][i]+(1-o)*r,n.push([a,e[f][u]])):n.push([null,e[f][u]]);return n},SUM:o,COUNT:function(e){return e.length},AVERAGE:function(e){var t=function(e){for(var t=[],n=0;n<e.length;n++)null!==e[n]&&t.push(e[n]);return t}(e);return 0===t.length?null:o(t)/t.length},MIN:function(e){return r.default.min(e)},MAX:function(e){return r.default.max(e)},MEDIAN:function(e){var t=r.default.sortBy(e);return t[Math.floor(t.length/2)]},PERCENTIL:function(e,t){var n=r.default.sortBy(t);return n[Math.floor(n.length*e/100)]},sortByTime:l};t.default=m},function(e,t){e.exports=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Zabbix=void 0;var r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(r=(u=o.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=p(n(1)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4)),o=p(n(28)),s=n(42),l=n(20),c=n(43),f=n(44),d=n(47);function p(e){return e&&e.__esModule?e:{default:e}}function m(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var h=["getHistory","getTrend","getGroups","getHosts","getApps","getItems","getMacros","getItemsByIDs","getEvents","getAlerts","getHostAlerts","getAcknowledges","getITService","getSLA","getVersion","getProxies","getEventAlerts","getExtendedEventData"],v=["getGroups","getHosts","getApps","getItems","getMacros","getItemsByIDs","getITService","getProxies"],g=["getHistory","getTrend","getMacros","getItemsByIDs","getEvents","getAlerts","getHostAlerts","getAcknowledges","getITService","getVersion","login","acknowledgeEvent","getProxies","getEventAlerts","getExtendedEventData"];t.Zabbix=function(){function e(t,n,r){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=t.url,u=t.username,o=t.password,l=t.basicAuth,f=t.withCredentials,d=t.zabbixVersion,p=t.cacheTTL,m=t.enableDirectDBConnection,h=t.dbConnectionDatasourceId,v=t.dbConnectionDatasourceName,g=t.dbConnectionRetentionPolicy;this.enableDirectDBConnection=m;var y={enabled:!0,ttl:p};if(this.cachingProxy=new s.CachingProxy(y),this.zabbixAPI=new c.ZabbixAPIConnector(i,u,o,d,l,f,r),this.proxyfyRequests(),this.cacheRequests(),this.bindRequests(),m){var b={dbConnectionRetentionPolicy:g};this.initDBConnector(h,v,n,b).then(function(){a.getHistoryDB=a.cachingProxy.proxyfyWithCache(a.dbConnector.getHistory,"getHistory",a.dbConnector),a.getTrendsDB=a.cachingProxy.proxyfyWithCache(a.dbConnector.getTrends,"getTrends",a.dbConnector)})}}return a(e,[{key:"initDBConnector",value:function(e,t,n,r){var a=this;return l.DBConnector.loadDatasource(e,t,n).then(function(i){var u={datasourceId:e,datasourceName:t};return"influxdb"===i.type?(u.retentionPolicy=r.dbConnectionRetentionPolicy,a.dbConnector=new d.InfluxDBConnector(u,n)):a.dbConnector=new f.SQLConnector(u,n),a.dbConnector})}},{key:"proxyfyRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=h[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this.zabbixAPI[i]=this.cachingProxy.proxyfy(this.zabbixAPI[i],i,this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{!e&&a.return&&a.return()}finally{if(t)throw n}}}},{key:"cacheRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=v[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this.zabbixAPI[i]=this.cachingProxy.cacheRequest(this.zabbixAPI[i],i,this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{!e&&a.return&&a.return()}finally{if(t)throw n}}}},{key:"bindRequests",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,a=g[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var i=r.value;this[i]=this.zabbixAPI[i].bind(this.zabbixAPI)}}catch(e){t=!0,n=e}finally{try{!e&&a.return&&a.return()}finally{if(t)throw n}}}},{key:"testDataSource",value:function(){var e=this,t=void 0,n=void 0;return this.getVersion().then(function(n){return t=n,e.login()}).then(function(){return e.enableDirectDBConnection?e.dbConnector.testDataSource():Promise.resolve()}).catch(function(e){return e instanceof l.ZabbixNotImplemented?Promise.resolve():Promise.reject(e)}).then(function(r){return r&&(n={dsType:e.dbConnector.datasourceTypeName,dsName:e.dbConnector.datasourceName}),{zabbixVersion:t,dbConnectorStatus:n}})}},{key:"getItemsFromTarget",value:function(e,t){var n=i.default.map(["group","host","application","item"],function(t){return e[t].filter});return this.getItems.apply(this,m(n).concat([t]))}},{key:"getHostsFromTarget",value:function(e){var t=i.default.map(["group","host","application"],function(t){return e[t].filter});return Promise.all([this.getHosts.apply(this,m(t)),this.getApps.apply(this,m(t))]).then(function(e){var t=r(e,2),n=t[0],a=t[1];return a.appFilterEmpty&&(a=[]),[n,a]})}},{key:"getAllGroups",value:function(){return this.zabbixAPI.getGroups()}},{key:"getGroups",value:function(e){return this.getAllGroups().then(function(t){return b(t,e)})}},{key:"getAllHosts",value:function(e){var t=this;return this.getGroups(e).then(function(e){var n=i.default.map(e,"groupid");return t.zabbixAPI.getHosts(n)})}},{key:"getHosts",value:function(e,t){return this.getAllHosts(e).then(function(e){return b(e,t)})}},{key:"getAllApps",value:function(e,t){var n=this;return this.getHosts(e,t).then(function(e){var t=i.default.map(e,"hostid");return n.zabbixAPI.getApps(t)})}},{key:"getApps",value:function(e,t,n){var r=this;return this.getHosts(e,t).then(function(e){var t=i.default.map(e,"hostid");return n?r.zabbixAPI.getApps(t).then(function(e){return T(e,n)}):{appFilterEmpty:!0,hostids:t}})}},{key:"getAllItems",value:function(e,t,n){var r=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.getApps(e,t,n).then(function(e){if(e.appFilterEmpty)return r.zabbixAPI.getItems(e.hostids,void 0,a.itemtype);var t=i.default.map(e,"applicationid");return r.zabbixAPI.getItems(void 0,t,a.itemtype)}).then(function(e){return a.showDisabledItems||(e=i.default.filter(e,{status:"0"})),e}).then(this.expandUserMacro.bind(this))}},{key:"expandUserMacro",value:function(e){var t=function(e){var t=i.default.map(e,function(e){return i.default.map(e.hosts,"hostid")});return i.default.uniq(i.default.flatten(t))}(e);return this.getMacros(t).then(function(t){return i.default.forEach(e,function(e){u.containsMacro(e.name)&&(e.name=u.replaceMacro(e,t))}),e})}},{key:"getItems",value:function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return this.getAllItems(e,t,n,a).then(function(e){return T(e,r)})}},{key:"getITServices",value:function(e){return this.zabbixAPI.getITService().then(function(t){return b(t,e)})}},{key:"getTriggers",value:function(e,t,n,a,u){var o=this,s=[this.getGroups(e),this.getHosts(e,t),this.getApps(e,t,n)];return Promise.all(s).then(function(a){var u=r(a,3),o=u[0],s=u[1],l=u[2],c={};return n&&(c.applicationids=i.default.flatten(i.default.map(l,"applicationid"))),t&&(c.hostids=i.default.map(s,"hostid")),e&&(c.groupids=i.default.map(o,"groupid")),c}).then(function(e){return o.zabbixAPI.getTriggers(e.groupids,e.hostids,e.applicationids,a)}).then(function(e){return o.filterTriggersByProxy(e,u)})}},{key:"filterTriggersByProxy",value:function(e,t){return this.getFilteredProxies(t).then(function(n){if(t&&"/.*/"!==t&&e){var r=n.map(function(e){return e.proxyid});e=e.filter(function(e){for(var t=!1,n=0;n<e.hosts.length;n++){var a=e.hosts[n];r.includes(a.proxy_hostid)&&(t=!0)}return t})}return e})}},{key:"getFilteredProxies",value:function(e){return this.zabbixAPI.getProxies().then(function(t){return t.forEach(function(e){return e.name=e.host}),b(t,e)})}},{key:"getHistoryTS",value:function(e,t,n){var a=this,i=r(t,2),u=i[0],s=i[1];return this.enableDirectDBConnection?this.getHistoryDB(e,u,s,n).then(function(t){return a.dbConnector.handleGrafanaTSResponse(t,e)}):this.zabbixAPI.getHistory(e,u,s).then(function(t){return o.default.handleHistory(t,e)})}},{key:"getTrends",value:function(e,t,n){var a=this,i=r(t,2),u=i[0],s=i[1];if(this.enableDirectDBConnection)return this.getTrendsDB(e,u,s,n).then(function(t){return a.dbConnector.handleGrafanaTSResponse(t,e)});var l=n.consolidateBy||n.valueType;return this.zabbixAPI.getTrend(e,u,s).then(function(t){return o.default.handleTrends(t,e,l)}).then(o.default.sortTimeseries)}},{key:"getHistoryText",value:function(e,t,n){var a=r(t,2),i=a[0],u=a[1];return e.length?this.zabbixAPI.getHistory(e,i,u).then(function(t){return"table"===n.resultFormat?o.default.handleHistoryAsTable(t,e,n):o.default.handleText(t,e,n)}):Promise.resolve([])}},{key:"getSLA",value:function(e,t,n,r){var a=e;r.isOldVersion&&(a=i.default.filter(a,{serviceid:n.itservice.serviceid}));var u=i.default.map(a,"serviceid");return this.zabbixAPI.getSLA(u,t).then(function(e){return i.default.map(u,function(t){var r=i.default.find(a,{serviceid:t});return o.default.handleSLAResponse(r,n.slaProperty,e)})})}}]),e}();function y(e,t){var n=u.buildRegex(t);return i.default.filter(e,function(e){return n.test(e.name)})}function b(e,t){return u.isRegex(t)?y(e,t):function(e,t){var n=i.default.find(e,{name:t});return n?[n]:[]}(e,t)}function T(e,t){return u.isRegex(t)?y(e,t):function(e,t){var n=i.default.filter(e,{name:t});return n||[]}(e,t)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();t.CachingProxy=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cacheEnabled=t.enabled,this.ttl=t.ttl||6e5,this.cache={},this.promises={}}return r(e,[{key:"cacheRequest",value:function(e,t,n){return function(e,t,n,r){return function(){r.cache[t]||(r.cache[t]={});var i=r.cache[t],u=a(arguments);return r.cacheEnabled&&!r._isExpired(i[u])?Promise.resolve(i[u].value):e.apply(n,arguments).then(function(e){return i[u]={value:e,timestamp:Date.now()},e})}}(e,t,n,this)}},{key:"proxyfy",value:function(e,t,n){return this.promises[t]||(this.promises[t]={}),function(e,t,n){return function(){var r=a(arguments);return t[r]||(t[r]=Promise.resolve(e.apply(n,arguments).then(function(e){return t[r]=null,e}))),t[r]}}(e,this.promises[t],n)}},{key:"proxyfyWithCache",value:function(e,t,n){var r=this.proxyfy(e,t,n);return this.cacheRequest(r,t,n)}},{key:"_isExpired",value:function(e){if(e){var t=Date.now()-e.timestamp;return!(e.timestamp&&t<this.ttl)}return!0}}]),e}();function a(e){return JSON.stringify(e).getHash()}String.prototype.getHash=function(){var e,t,n=0;if(0!==this.length)for(e=0,t=this.length;e<t;e++)n=(n<<5)-n+this.charCodeAt(e),n|=0;return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZabbixAPIConnector=void 0;var r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(r=(u=o.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(a)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(n(1)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(4)),o=n(29),s=n(12);t.ZabbixAPIConnector=function(){function e(t,n,r,a,i,u,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.url=t,this.username=n,this.password=r,this.auth="",this.version=a,this.requestOptions={basicAuth:i,withCredentials:u},this.loginPromise=null,this.loginErrorCount=0,this.maxLoginAttempts=3,this.zabbixAPICore=new o.ZabbixAPICore(s),this.getTrend=this.getTrend_ZBXNEXT1193}return a(e,[{key:"request",value:function(e,t){var n=this;return this.zabbixAPICore.request(this.url,e,t,this.requestOptions,this.auth).catch(function(r){return function(e){return"Session terminated, re-login, please."===e||"Not authorised."===e||"Not authorized."===e}(r.data)?(n.loginErrorCount++,n.loginErrorCount>n.maxLoginAttempts?(n.loginErrorCount=0,null):n.loginOnce().then(function(){return n.request(e,t)})):Promise.reject(r)})}},{key:"loginOnce",value:function(){var e=this;return this.loginPromise||(this.loginPromise=Promise.resolve(this.login().then(function(t){return e.auth=t,e.loginPromise=null,t}))),this.loginPromise}},{key:"login",value:function(){return this.zabbixAPICore.login(this.url,this.username,this.password,this.requestOptions)}},{key:"getVersion",value:function(){return this.zabbixAPICore.getVersion(this.url,this.requestOptions)}},{key:"acknowledgeEvent",value:function(e,t){var n={eventids:e,message:t,action:this.version>=4?s.ZBX_ACK_ACTION_ACK+s.ZBX_ACK_ACTION_ADD_MESSAGE:s.ZBX_ACK_ACTION_NONE};return this.request("event.acknowledge",n)}},{key:"getGroups",value:function(){return this.request("hostgroup.get",{output:["name"],sortfield:"name",real_hosts:!0})}},{key:"getHosts",value:function(e){var t={output:["name","host"],sortfield:"name"};return e&&(t.groupids=e),this.request("host.get",t)}},{key:"getApps",value:function(e){var t={output:"extend",hostids:e};return this.request("application.get",t)}},{key:"getItems",value:function(e,t,n){var r={output:["name","key_","value_type","hostid","status","state"],sortfield:"name",webitems:!0,filter:{},selectHosts:["hostid","name"]};return e&&(r.hostids=e),t&&(r.applicationids=t),"num"===n&&(r.filter.value_type=[0,3]),"text"===n&&(r.filter.value_type=[1,2,4]),this.request("item.get",r).then(u.expandItems)}},{key:"getItemsByIDs",value:function(e){var t={itemids:e,output:["name","key_","value_type","hostid","status","state"],webitems:!0,selectHosts:["hostid","name"]};return this.request("item.get",t).then(u.expandItems)}},{key:"getMacros",value:function(e){var t={output:"extend",hostids:e};return this.request("usermacro.get",t)}},{key:"getGlobalMacros",value:function(){return this.request("usermacro.get",{output:"extend",globalmacro:!0})}},{key:"getLastValue",value:function(e){var t={output:["lastvalue"],itemids:e};return this.request("item.get",t).then(function(e){return e.length?e[0].lastvalue:null})}},{key:"getHistory",value:function(e,t,n){var r=this,a=i.default.groupBy(e,"value_type"),u=i.default.map(a,function(e,a){var u={output:"extend",history:a,itemids:i.default.map(e,"itemid"),sortfield:"clock",sortorder:"ASC",time_from:t};return n&&(u.time_till=n),r.request("history.get",u)});return Promise.all(u).then(i.default.flatten)}},{key:"getTrend_ZBXNEXT1193",value:function(e,t,n){var r=this,a=i.default.groupBy(e,"value_type"),u=i.default.map(a,function(e,a){var u={output:"extend",trend:a,itemids:i.default.map(e,"itemid"),sortfield:"clock",sortorder:"ASC",time_from:t};return n&&(u.time_till=n),r.request("trend.get",u)});return Promise.all(u).then(i.default.flatten)}},{key:"getTrend_30",value:function(e,t,n,r){var a={output:["itemid","clock",r],itemids:i.default.map(e,"itemid"),time_from:t};return n&&(a.time_till=n),this.request("trend.get",a)}},{key:"getITService",value:function(e){var t={output:"extend",serviceids:e};return this.request("service.get",t)}},{key:"getSLA",value:function(e,t){var n=r(t,2),a={serviceids:e,intervals:[{from:n[0],to:n[1]}]};return this.request("service.getsla",a)}},{key:"getTriggers",value:function(e,t,n,r){var a=r.showTriggers,i=r.maintenance,u=r.timeFrom,o=r.timeTo,s={output:"extend",groupids:e,hostids:t,applicationids:n,expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,filter:{value:1},selectGroups:["name"],selectHosts:["name","host","maintenance_status","proxy_hostid"],selectItems:["name","key_","lastvalue"],selectLastEvent:"extend",selectTags:"extend"};return a&&(s.filter.value=a),i&&(s.maintenance=!0),(u||o)&&(s.lastChangeSince=u,s.lastChangeTill=o),this.request("trigger.get",s)}},{key:"getEvents",value:function(e,t,n,r,a){var i={output:"extend",time_from:t,time_till:n,objectids:e,select_acknowledges:"extend",selectHosts:"extend",value:r};return a&&(i.limit=a,i.sortfield="clock",i.sortorder="DESC"),this.request("event.get",i)}},{key:"getAcknowledges",value:function(e){var t={output:"extend",eventids:e,preservekeys:!0,select_acknowledges:"extend",sortfield:"clock",sortorder:"DESC"};return this.request("event.get",t).then(function(e){return i.default.filter(e,function(e){return e.acknowledges.length})})}},{key:"getExtendedEventData",value:function(e){var t={output:"extend",eventids:e,preservekeys:!0,select_acknowledges:"extend",selectTags:"extend",sortfield:"clock",sortorder:"DESC"};return this.request("event.get",t)}},{key:"getEventAlerts",value:function(e){var t={eventids:e,output:"extend",selectUsers:!0};return this.request("alert.get",t)}},{key:"getAlerts",value:function(e,t,n){var r={output:"extend",itemids:e,expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,selectLastEvent:"extend"};return(t||n)&&(r.lastChangeSince=t,r.lastChangeTill=n),this.request("trigger.get",r)}},{key:"getHostAlerts",value:function(e,t,n){var r=n.minSeverity,a=n.acknowledged,u=n.count,o=n.timeFrom,s=n.timeTo,l={output:"extend",hostids:e,min_severity:r,filter:{value:1},expandDescription:!0,expandData:!0,expandComment:!0,monitored:!0,skipDependent:!0,selectLastEvent:"extend",selectGroups:"extend",selectHosts:["host","name"]};return u&&0!==a&&1!==a&&(l.countOutput=!0),t&&t.length&&(l.applicationids=t),(o||s)&&(l.lastChangeSince=o,l.lastChangeTill=s),this.request("trigger.get",l).then(function(e){return u&&0!==a&&1!==a||(e=function(e,t){return 0===t?i.default.filter(e,function(e){return"0"===e.lastEvent.acknowledged}):1===t?i.default.filter(e,function(e){return"1"===e.lastEvent.acknowledged}):e}(e,a),u&&(e=e.length)),e})}},{key:"getProxies",value:function(){return this.request("proxy.get",{output:["proxyid","host"]})}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SQLConnector=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function e(t,n,r){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in a)return a.value;var u=a.get;return void 0!==u?u.call(r):void 0},i=f(n(1)),u=n(4),o=f(n(45)),s=f(n(46)),l=n(20),c=f(l);function f(e){return e&&e.__esModule?e:{default:e}}var d="postgres";t.SQLConnector=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.limit=e.limit||l.DEFAULT_QUERY_LIMIT,r.sqlDialect=null,a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"loadDBDataSource",r).call(r).then(function(e){r.backendSrv=e.backendSrv,r.loadSQLDialect()}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,l.DBConnector),r(t,[{key:"loadSQLDialect",value:function(){this.datasourceTypeId===d?this.sqlDialect=s.default:this.sqlDialect=o.default}},{key:"testDataSource",value:function(){var e=this.sqlDialect.testQuery();return this.invokeSQLQuery(e)}},{key:"getHistory",value:function(e,t,n,r){var a=this,o=r.intervalMs,s=r.consolidateBy,f=Math.ceil(o/1e3);s=s||"avg";var d=c.default.consolidateByFunc[s],p=i.default.groupBy(e,"value_type"),m=i.default.map(p,function(e,r){var o=i.default.map(e,"itemid").join(", "),s=l.HISTORY_TO_TABLE_MAP[r],c=a.sqlDialect.historyQuery(o,s,t,n,f,d);return c=(0,u.compactQuery)(c),a.invokeSQLQuery(c)});return Promise.all(m).then(function(e){return i.default.flatten(e)})}},{key:"getTrends",value:function(e,t,n,r){var a=this,o=r.intervalMs,s=r.consolidateBy,f=Math.ceil(o/1e3);s=s||"avg";var d=c.default.consolidateByFunc[s],p=i.default.groupBy(e,"value_type"),m=i.default.map(p,function(e,r){var o=i.default.map(e,"itemid").join(", "),p=l.TREND_TO_TABLE_MAP[r],m=i.default.includes(["avg","min","max","sum"],s)?s:"avg";m=c.default.consolidateByTrendColumns[m];var h=a.sqlDialect.trendsQuery(o,p,t,n,f,d,m);return h=(0,u.compactQuery)(h),a.invokeSQLQuery(h)});return Promise.all(m).then(function(e){return i.default.flatten(e)})}},{key:"invokeSQLQuery",value:function(e){var t={refId:"A",format:"time_series",datasourceId:this.datasourceId,rawSql:e,maxDataPoints:this.limit};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{queries:[t]}}).then(function(e){var t=e.data.results;return t.A?t.A.series:null})}}]),t}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="SELECT CAST(itemid AS CHAR) AS metric, clock AS time_sec, value_avg AS value FROM trends_uint LIMIT 1";var a={historyQuery:function(e,t,n,r,a,i){var u="clock DIV "+a+" * "+a;return"\n    SELECT CAST(itemid AS CHAR) AS metric, "+u+" AS time_sec, "+i+"(value) AS value\n    FROM "+t+"\n    WHERE itemid IN ("+e+")\n      AND clock > "+n+" AND clock < "+r+"\n    GROUP BY "+u+", metric\n    ORDER BY time_sec ASC\n  "},trendsQuery:function(e,t,n,r,a,i,u){var o="clock DIV "+a+" * "+a;return"\n    SELECT CAST(itemid AS CHAR) AS metric, "+o+" AS time_sec, "+i+"("+u+") AS value\n    FROM "+t+"\n    WHERE itemid IN ("+e+")\n      AND clock > "+n+" AND clock < "+r+"\n    GROUP BY "+o+", metric\n    ORDER BY time_sec ASC\n  "},testQuery:function(){return r}};t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="FM99999999999999999999";var a="\n  SELECT to_char(itemid, '"+r+"') AS metric, clock AS time, value_avg AS value\n  FROM trends_uint LIMIT 1\n";var i={historyQuery:function(e,t,n,a,i,u){return"\n    SELECT to_char(itemid, '"+r+"') AS metric, clock / "+i+" * "+i+" AS time, "+u+"(value) AS value\n    FROM "+t+"\n    WHERE itemid IN ("+e+")\n      AND clock > "+n+" AND clock < "+a+"\n    GROUP BY 1, 2\n    ORDER BY time ASC\n  "},trendsQuery:function(e,t,n,a,i,u,o){return"\n    SELECT to_char(itemid, '"+r+"') AS metric, clock / "+i+" * "+i+" AS time, "+u+"("+o+") AS value\n    FROM "+t+"\n    WHERE itemid IN ("+e+")\n      AND clock > "+n+" AND clock < "+a+"\n    GROUP BY 1, 2\n    ORDER BY time ASC\n  "},testQuery:function(){return a}};t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InfluxDBConnector=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function e(t,n,r){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in a)return a.value;var u=a.get;return void 0!==u?u.call(r):void 0},i=function(e){return e&&e.__esModule?e:{default:e}}(n(1)),u=n(4),o=n(20);var s={avg:"MEAN",min:"MIN",max:"MAX",sum:"SUM",count:"COUNT"};t.InfluxDBConnector=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r.retentionPolicy=e.retentionPolicy,a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"loadDBDataSource",r).call(r).then(function(e){return r.influxDS=e,e}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.DBConnector),r(t,[{key:"testDataSource",value:function(){return this.influxDS.testDatasource()}},{key:"getHistory",value:function(e,t,n,r){var a=this,u=r.intervalMs,s=r.consolidateBy,l=r.retentionPolicy,c=Math.ceil(u/1e3),f={timeFrom:t,timeTill:n};s=s||"avg";var d=i.default.groupBy(e,"value_type"),p=i.default.map(d,function(e,t){var n=i.default.map(e,"itemid"),r=o.HISTORY_TO_TABLE_MAP[t],u=a.buildHistoryQuery(n,r,f,c,s,l);return a.invokeInfluxDBQuery(u)});return Promise.all(p).then(i.default.flatten).then(function(e){return function(e){if(!e)return[];for(var t=[],n=0;n<e.length;n++){var r=e[n];if(r.error){var a="InfluxDB error: "+r.error;return Promise.reject(new Error(a))}if(r&&r.series)for(var i=e[n].series,u=0;u<i.length;u++){var o=i[u],s=[];if(o.values)for(n=0;n<o.values.length;n++)s[n]=[o.values[n][1],o.values[n][0]];var l={name:o.tags.itemid,points:s};t.push(l)}}return t}(e)})}},{key:"getTrends",value:function(e,t,n,r){return r.retentionPolicy=this.retentionPolicy,this.getHistory(e,t,n,r)}},{key:"buildHistoryQuery",value:function(e,t,n,r,a,i){var l=n.timeFrom,c=n.timeTill,f=i?'"'+i+'"."'+t+'"':'"'+t+'"',d="value";i&&(d=o.consolidateByTrendColumns[a]||"value_avg");var p="SELECT "+(s[a]||a)+'("'+d+'") FROM '+f+"\n      WHERE "+this.buildWhereClause(e)+' AND "time" >= '+l+'s AND "time" <= '+c+"s\n      GROUP BY time("+r+'s), "itemid" fill(none)';return(0,u.compactQuery)(p)}},{key:"buildWhereClause",value:function(e){return"("+e.map(function(e){return'"itemid" = \''+e+"'"}).join(" OR ")+")"}},{key:"invokeInfluxDBQuery",value:function(e){return this.influxDS._seriesQuery(e).then(function(e){return e&&e.results?e.results:[]})}}]),t}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZabbixQueryController=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(6),i=function(e){return e&&e.__esModule?e:{default:e}}(n(1)),u=c(n(12)),o=c(n(4)),s=c(n(19)),l=c(n(18));function c(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}t.ZabbixQueryController=function(e){function t(e,n,r,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return c.zabbix=c.datasource.zabbix,c.replaceTemplateVars=c.datasource.replaceTemplateVars,c.templateSrv=o,c.editorModes=[{value:"num",text:"Metrics",mode:u.MODE_METRICS},{value:"text",text:"Text",mode:u.MODE_TEXT},{value:"itservice",text:"IT Services",mode:u.MODE_ITSERVICE},{value:"itemid",text:"Item ID",mode:u.MODE_ITEMID},{value:"triggers",text:"Triggers",mode:u.MODE_TRIGGERS}],c.$scope.editorMode={METRICS:u.MODE_METRICS,TEXT:u.MODE_TEXT,ITSERVICE:u.MODE_ITSERVICE,ITEMID:u.MODE_ITEMID,TRIGGERS:u.MODE_TRIGGERS},c.slaPropertyList=[{name:"Status",property:"status"},{name:"SLA",property:"sla"},{name:"OK time",property:"okTime"},{name:"Problem time",property:"problemTime"},{name:"Down time",property:"downtimeTime"}],c.ackFilters=[{text:"all triggers",value:2},{text:"unacknowledged",value:0},{text:"acknowledged",value:1}],c.resultFormats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],c.triggerSeverity=u.TRIGGER_SEVERITY,c.getGroupNames=i.default.bind(c.getMetricNames,c,"groupList"),c.getHostNames=i.default.bind(c.getMetricNames,c,"hostList",!0),c.getApplicationNames=i.default.bind(c.getMetricNames,c,"appList"),c.getItemNames=i.default.bind(c.getMetricNames,c,"itemList"),c.getITServices=i.default.bind(c.getMetricNames,c,"itServiceList"),c.getVariables=i.default.bind(c.getTemplateVariables,c),r.$on("template-variable-value-updated",function(){return c.onVariableChange()}),e.$on("typeahead-updated",function(){c.onTargetBlur()}),c.init=function(){var e=this.target;e=l.migrate(e);var t={metric:{},oldTarget:i.default.cloneDeep(this.target),queryOptionsText:this.renderQueryOptionsText()};i.default.defaults(this,t);var n={mode:u.MODE_METRICS,group:{filter:""},host:{filter:""},application:{filter:""},item:{filter:""},functions:[],triggers:{count:!0,minSeverity:3,acknowledged:2},options:{showDisabledItems:!1,skipEmptyValues:!1},table:{skipEmptyValues:!1}};i.default.defaults(e,n),e.functions=i.default.map(e.functions,function(e){return s.createFuncInstance(e.def,e.params)}),e.mode===u.MODE_METRICS||e.mode===u.MODE_TEXT||e.mode===u.MODE_TRIGGERS?this.initFilters():e.mode===u.MODE_ITSERVICE&&(i.default.defaults(e,{slaProperty:{name:"SLA",property:"sla"}}),this.suggestITServices())},c.init(),c.queryOptionsText=c.renderQueryOptionsText(),c}return t.$inject=["$scope","$injector","$rootScope","$sce","templateSrv"],function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"initFilters",value:function(){var e=i.default.find(this.editorModes,{mode:this.target.mode});return e=e?e.value:null,Promise.all([this.suggestGroups(),this.suggestHosts(),this.suggestApps(),this.suggestItems(e)])}},{key:"getMetricNames",value:function(e,t){var n=i.default.uniq(i.default.map(this.metric[e],"name"));return i.default.forEach(this.templateSrv.variables,function(e){n.unshift("$"+e.name)}),t&&n.unshift("/.*/"),n}},{key:"getTemplateVariables",value:function(){return i.default.map(this.templateSrv.variables,function(e){return"$"+e.name})}},{key:"suggestGroups",value:function(){var e=this;return this.zabbix.getAllGroups().then(function(t){return e.metric.groupList=t,t})}},{key:"suggestHosts",value:function(){var e=this,t=this.replaceTemplateVars(this.target.group.filter);return this.zabbix.getAllHosts(t).then(function(t){return e.metric.hostList=t,t})}},{key:"suggestApps",value:function(){var e=this,t=this.replaceTemplateVars(this.target.group.filter),n=this.replaceTemplateVars(this.target.host.filter);return this.zabbix.getAllApps(t,n).then(function(t){return e.metric.appList=t,t})}},{key:"suggestItems",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"num",n=this.replaceTemplateVars(this.target.group.filter),r=this.replaceTemplateVars(this.target.host.filter),a=this.replaceTemplateVars(this.target.application.filter),i={itemtype:t,showDisabledItems:this.target.options.showDisabledItems};return this.zabbix.getAllItems(n,r,a,i).then(function(t){return e.metric.itemList=t,t})}},{key:"suggestITServices",value:function(){var e=this;return this.zabbix.getITService().then(function(t){return e.metric.itServiceList=t,t})}},{key:"isRegex",value:function(e){return o.isRegex(e)}},{key:"isVariable",value:function(e){return o.isTemplateVariable(e,this.templateSrv.variables)}},{key:"onTargetBlur",value:function(){var e=i.default.cloneDeep(this.target);i.default.isEqual(this.oldTarget,this.target)||(this.oldTarget=e,this.targetChanged())}},{key:"onVariableChange",value:function(){this.isContainsVariables()&&this.targetChanged()}},{key:"isContainsVariables",value:function(){var e=this;return i.default.some(["group","host","application"],function(t){return!(!e.target[t]||!e.target[t].filter)&&o.isTemplateVariable(e.target[t].filter,e.templateSrv.variables)})}},{key:"parseTarget",value:function(){}},{key:"validateTarget",value:function(){}},{key:"targetChanged",value:function(){this.initFilters(),this.parseTarget(),this.panelCtrl.refresh()}},{key:"addFunction",value:function(e){var t=s.createFuncInstance(e);t.added=!0,this.target.functions.push(t),this.moveAliasFuncLast(),(t.params.length&&t.added||0===t.def.params.length)&&this.targetChanged()}},{key:"removeFunction",value:function(e){this.target.functions=i.default.without(this.target.functions,e),this.targetChanged()}},{key:"moveAliasFuncLast",value:function(){var e=i.default.find(this.target.functions,function(e){return"alias"===e.def.name||"aliasByNode"===e.def.name||"aliasByMetric"===e.def.name});e&&(this.target.functions=i.default.without(this.target.functions,e),this.target.functions.push(e))}},{key:"toggleQueryOptions",value:function(){this.showQueryOptions=!this.showQueryOptions}},{key:"onQueryOptionChange",value:function(){this.queryOptionsText=this.renderQueryOptionsText(),this.onTargetBlur()}},{key:"renderQueryOptionsText",value:function(){var e={showDisabledItems:"Show disabled items",skipEmptyValues:"Skip empty values"},t=[];return i.default.forOwn(this.target.options,function(n,r){n&&(!0===n?t.push(e[r]):t.push(e[r]+" = "+n))}),"Options: "+t.join(", ")}},{key:"switchEditorMode",value:function(e){this.target.mode=e,this.init(),this.targetChanged()}}]),t}(a.QueryCtrl)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZabbixDSConfigController=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(e){return e&&e.__esModule?e:{default:e}}(n(1)),i=n(18);var u=["mysql","postgres","influxdb"],o=[{name:"2.x",value:2},{name:"3.x",value:3},{name:"4.x",value:4}],s={trends:!1,dbConnectionEnable:!1,dbConnectionDatasourceId:null,alerting:!1,addThresholds:!1,alertingMinSeverity:3,disableReadOnlyUsersAck:!1,zabbixVersion:3};t.ZabbixDSConfigController=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.datasourceSrv=r,this.current.jsonData=(0,i.migrateDSConfig)(this.current.jsonData),a.default.defaults(this.current.jsonData,s),this.dbDataSources=this.getSupportedDBDataSources(),this.zabbixVersions=a.default.cloneDeep(o),this.autoDetectZabbixVersion()}return e.$inject=["$scope","$injector","datasourceSrv"],r(e,[{key:"getSupportedDBDataSources",value:function(){var e=this.datasourceSrv.getAll();return a.default.filter(e,function(e){return a.default.includes(u,e.type)})}},{key:"getCurrentDatasourceType",value:function(){var e=this.current.jsonData.dbConnectionDatasourceId,t=a.default.find(this.dbDataSources,{id:e});return t?t.type:null}},{key:"autoDetectZabbixVersion",value:function(){var e=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion()}).then(function(t){t&&(a.default.find(o,["value",t])||e.zabbixVersions.push({name:t+".x",value:t}),e.current.jsonData.zabbixVersion=t)})}}]),e}()},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=o(n(1)),i=o(n(11)),u=o(n(10));function o(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.dashboardSrv=t}return e.$inject=["dashboardSrv"],r(e,[{key:"isFullScreen",value:function(){return this.dashboardSrv.dash.meta.fullscreen}},{key:"setPanelAlertState",value:function(e,t){var n=void 0,r=a.default.filter((0,i.default)(".panel-container"),function(e){return e.clientHeight&&e.clientWidth}),u=this.getPanelModels();if((n=this.isFullScreen()?0:a.default.findIndex(u,function(t){return t.id===e}))>=0){var o="panel-has-alert panel-alert-state--ok panel-alert-state--alerting";(0,i.default)(r[n]).removeClass(o),t&&("alerting"===t&&(o="panel-has-alert panel-alert-state--"+t,(0,i.default)(r[n]).addClass(o)),"ok"===t&&(o="panel-alert-state--"+t,(0,i.default)(r[n]).addClass(o),(0,i.default)(r[n]).removeClass("panel-has-alert")))}}},{key:"getPanelModels",value:function(){return a.default.filter(this.dashboardSrv.dash.panels,function(e){return"row"!==e.type})}},{key:"getPanelModel",value:function(e){var t=this.getPanelModels();return a.default.find(t,function(t){return t.id===e})}},{key:"setPanelThreshold",value:function(e,t){var n=this.getPanelModel(e),r=a.default.find(n.thresholds,{value:t});if(n&&"graph"===n.type&&!r){var i={colorMode:"custom",fill:!1,line:!0,lineColor:"rgb(255, 0, 0)",op:"gt",value:t,source:"zabbix"};n.thresholds.push(i)}}},{key:"removeZabbixThreshold",value:function(e){var t=this.getPanelModel(e);t&&"graph"===t.type&&(t.thresholds=a.default.filter(t.thresholds,function(e){return"zabbix"!==e.source}))}}]),e}();u.default.module("grafana.services").service("zabbixAlertingSrv",s)},function(e,t,n){"use strict";var r=o(n(10)),a=o(n(1)),i=o(n(11)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(19));function o(e){return e&&e.__esModule?e:{default:e}}r.default.module("grafana.directives").directive("addMetricFunction",["$compile",function(e){return{link:function(t,n){var r=u.getCategories(),o=function(e){return a.default.reduce(e,function(e,t){return a.default.each(t,function(t){e.push(t.name)}),e},[])}(r);t.functionMenu=function(e){return a.default.map(e,function(e,t){return{text:t,submenu:a.default.map(e,function(e){return{text:e.name,click:"ctrl.addFunction('"+e.name+"')"}})}})}(r);var s=(0,i.default)('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),l=(0,i.default)('<a  class="gf-form-label tight-form-func dropdown-toggle query-part" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');s.appendTo(n),l.appendTo(n),s.attr("data-provide","typeahead"),s.typeahead({source:o,minLength:1,items:10,updater:function(e){var n=u.getFuncDef(e);if(n||(e=e.toLowerCase(),n=a.default.find(o,function(t){return 0===t.toLowerCase().indexOf(e)})))return t.$apply(function(){t.addFunction(n)}),s.trigger("blur"),""}}),l.click(function(){l.hide(),s.show(),s.focus()}),s.keyup(function(){n.toggleClass("open",""===s.val())}),s.blur(function(){setTimeout(function(){s.val(""),s.hide(),l.show(),n.removeClass("open")},200)}),e(n.contents())(t)}}}])},function(e,t,n){"use strict";var r=u(n(10)),a=u(n(1)),i=u(n(11));function u(e){return e&&e.__esModule?e:{default:e}}var o="https://alexanderzobnin.github.io/grafana-zabbix/reference/functions/";r.default.module("grafana.directives").directive("metricFunctionEditor",["$compile","templateSrv",function(e,t){var n='<input type="text" style="display:none" class="input-mini tight-form-func-param"></input>';return{restrict:"A",link:function(r,u){var s=(0,i.default)('<a ng-click="">{{func.def.name}}</a><span>(</span>'),l=(0,i.default)('<div class="tight-form-func-controls"><span class="pointer fa fa-arrow-left"></span><span class="pointer fa fa-question-circle"></span><span class="pointer fa fa-remove" ></span><span class="pointer fa fa-arrow-right"></span></div>'),c=r.ctrl,f=r.func,d=f.def,p=!1,m=0;function h(e){var t=(0,i.default)(this),n=t.next();n.val(f.params[e]),n.css("width",t.width()+16+"px"),t.hide(),n.show(),n.focus(),n.select();var r=n.data("typeahead");r&&(n.val(""),r.lookup())}function v(e){var n=(0,i.default)(this),a=n.prev(),u=n.val();(""!==u||f.def.params[e].optional)&&(a.html(t.highlightVariablesAsHtml(u)),f.updateParam(n.val(),e),m!==f.params.length&&(p||(p=!0,setTimeout(function(){x(),p=!1},200))),r.$apply(function(){c.targetChanged()}),n.hide(),a.show())}function g(e,t){13===t.which&&v.call(this,e)}function y(){this.style.width=8*(3+this.value.length)+"px"}function b(){var e=u.closest(".tight-form");if(u.hasClass("show-function-controls"))return u.removeClass("show-function-controls"),e.removeClass("has-open-function"),void l.hide();u.addClass("show-function-controls"),e.addClass("has-open-function"),l.show()}function T(){l.appendTo(u),s.appendTo(u),a.default.each(d.params,function(e,r){if(!(e.optional&&f.params.length<=r)){r>0&&(0,i.default)("<span>, </span>").appendTo(u);var o=t.highlightVariablesAsHtml(f.params[r]),s=(0,i.default)('<a ng-click="" class="graphite-func-param-link">'+o+"</a>"),l=(0,i.default)(n);m++,s.appendTo(u),l.appendTo(u),l.blur(a.default.partial(v,r)),l.keyup(y),l.keypress(a.default.partial(g,r)),s.click(a.default.partial(h,r)),d.params[r].options&&function(e,t){e.attr("data-provide","typeahead");var n=d.params[t].options;"int"!==d.params[t].type&&"float"!==d.params[t].type||(n=a.default.map(n,function(e){return e.toString()})),e.typeahead({source:n,minLength:0,items:20,updater:function(n){return setTimeout(function(){v.call(e[0],t)},0),n}}),e.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(l,r)}}),(0,i.default)("<span>)</span>").appendTo(u),e(u.contents())(r)}function x(){u.children().remove(),T(),r.func.added&&(r.func.added=!1,setTimeout(function(){u.find(".graphite-func-param-link").first().click()},10)),s.click(b),l.click(function(e){var t=(0,i.default)(e.target);if(t.hasClass("fa-remove"))return b(),void r.$apply(function(){c.removeFunction(r.func)});if(t.hasClass("fa-arrow-left"))r.$apply(function(){a.default.move(r.target.functions,r.$index,r.$index-1),c.targetChanged()});else if(t.hasClass("fa-arrow-right"))r.$apply(function(){a.default.move(r.target.functions,r.$index,r.$index+1),c.targetChanged()});else if(t.hasClass("fa-question-circle")){var n=o;window.open(n+"#"+d.name.toLowerCase(),"_blank")}})}x()}}}])}])});
//# sourceMappingURL=module.js.map